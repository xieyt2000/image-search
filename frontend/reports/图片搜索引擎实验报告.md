# 图片搜索引擎实验报告

乐阳      计84  2018011359

谢云桐  计83  2018011334



## 问题描述

#### 背景

本项目使用 [Open Image Dataset V6](https://storage.googleapis.com/openimages/web/index.html) 中的验证集（validation split），共 41620 张图片，大小约 12 G，在此之上搭建图片搜索引擎。由于该数据集中图片分布较为多样，不便于测试以图搜图的性能，同时该数据集中绝大部分图片都有人工和机器标注的分类标签，对文字搜索较为友好，因此本项目使用文字作为查询词

#### 问题描述

用户在前端界面中给定数个英文单词（或一句话），搜索引擎在数据集中搜索与其相关的图片并依据综合相关度进行排序后，返回前端展示给用户。同时作为附加功能，支持按照图片的尺寸、颜色进行筛选展示搜索结果，支持中文搜索，并在用户浏览图片详情时进一步搜索与该图片相似的图片



## 实现模块

本项目可以粗略地分为以下三个模块

- 数据预处理：下载数据，建立索引
- 网站后端：处理请求，搜索排序
- 网站前端：用户交互

### 实现细节

#### 数据预处理

#### 网站前端

- 使用 Vue.js 作为基础框架，编写逻辑
- 使用 Nuxt.js 创建服务端渲染应用，也可以静态部署
- 使用 Vuetify 绘制 UI

UI 设计上参考了 Google Image Search，简约美观，交互逻辑自然

- 主页

  <img src="图片搜索引擎实验报告_pic/image-20210608211753137.png" alt="image-20210608211753137" style="zoom:50%;" />

  简约风格，只有 logo、搜索框和搜索按钮，支持回车查询

- 结果展示页

  <img src="图片搜索引擎实验报告_pic/image-20210608212237523.png" alt="image-20210608212237523" style="zoom:50%;" />

  <img src="图片搜索引擎实验报告_pic/image-20210608212701153.png" alt="image-20210608212701153" style="zoom:50%;" />

  最顶部为应用工具栏，点击 logo 返回主页，可在搜索框中输入内容后回车查找，点击漏斗图标后弹出筛选对话框

  主体部分展示搜索结果，考虑流畅度，此处展示缩略图，可以单机进入图片详情对话框，每张图下方放置指向原网页的链接（因数据集中没有该信息，所以暂时为占位符）

  底部显示搜索结果数、搜索请求计时，实现翻页

- 筛选对话框

  <img src="图片搜索引擎实验报告_pic/image-20210608213139269.png" alt="image-20210608213139269" style="zoom:50%;" />

  选择筛选规则，大小使用选项，颜色在选中 Pick color 时会出现调色盘进行颜色选择

- 图片详情对话框

  <img src="图片搜索引擎实验报告_pic/image-20210608212859075.png" alt="image-20210608212859075" style="zoom:50%;" />

  展示图片详情，相比结果展示页的信息，加入图片描述（如原网站中与搜索词匹配的文段）并使用高清大图，下方展示 20 张相似图片

- 错误页面

  <img src="图片搜索引擎实验报告_pic/image-20210608212204831.png" alt="image-20210608212204831" style="zoom:50%;" />

  展示出错信息，可继续进行搜索/返回主页

#### 网站后端

- 使用Django作为基本框架
- 使用内存中的数据结构作为数据库（避免Django数据库频繁读盘造成的性能损失）
  - 封装为类 `DB`
  - `DB.img_info` 存储图片信息，包括路径、标签、大小、颜色等
  - `DB.label_info`存储标签信息，包括其词向量、倒排索引等
  - `DB.word_vec`存储一些常用词的词向量，方便转换查询词
- 主要API
  - `api/image`：根据图片ID获取图片，可以指定缩放大小
  - `api/search`：核心搜索，包括基本搜索和条件筛选
  - `api/similar`：根据图片ID获取相似图片，可指定返回张数

## 关键功能

### 图片搜索

在本项目的实现中，图片搜索的本质其实是**对图片标签的搜索**，因此我们先简要介绍数据集的标签组成。

在 Open Image Dataset V6 数据集中，每一张图片带有多个标签。这些标签由视觉模型自动生成，再经过人工筛选分为正标签（positive label）和负标签（negative label）两类。

- 正标签：人认为该标签与图片相关
- 负标签：由模型提出，但被人否定的标签

因此我们可以认为正标签是图片信息的一个良好代表，而负标签虽然被否定但也与图片有一定的联系。在进行搜索排序时，每图片的带有的每个标签都会被赋予一个**权重**，我们将综合考虑正标签和负标签，但前者的权重会显著大于后者。具体而言，如果一张图 $I$ 有 $M$ 个正标签和 $N$ 个负标签，则其每个正标签对于这张图的权重为 $w_I(p)1+\frac 1 {1+\log M}$，每个负标签的权重为 $w_I(n)=0.05\times \frac 1 N$。这样设计的考量主要是，让每个正标签都有明显高于负标签的基础权重（为1），同时认为如果标签总数较少则标签与图片的相关性更大。在这个设计中每张图片的标签权重总和并不固定，这是为了让一张图有多个标签符合查询词时的权重和更高。

按照上述方法定义的标签权重，我们对每个标签建立**倒排索引**。一个标签的倒排索引列表中，每个索引项为 `(图片id, 标签权重)` 的二元组。

标签中词项的数目毕竟有限，为了尽量对任意一个查询词返回有意义的结果，需要获得查询词与标签之间的语义匹配关系。一种直接的方法就是利用预训练的**词向量**。本项目采用的是 [FastText](https://fasttext.cc/docs/en/english-vectors.html) wiki-news-300d-1M 词向量，该数据集收录英文词汇近百万个，在维基百科2017上训练得出。根据词向量，我们就能用标签和查询词之间的余弦距离来衡量相关程度，这个数值也方便引擎对搜索结果进行排序。

我们的搜索总流程为：

1. 用户输出查询词，首先检查查询词是否为纯英文，若否则首先进行**中英翻译**（因此我们的搜索引擎支持双语搜索）

2. 将查询词转化为词向量（可能为多个），计算查询词与数据库中每个label的余弦相似度，取相似度前 $K$ 名的标签 $c_1,\dots,c_K$，分别对应相似度 $s_1,\dots,s_K$

3. 查询这 $K$ 个标签的倒排索引，将所有包含这些标签的图片作为候选项，对每张图片计算最终的**相关得分**。相关得分的定义如下，其中 $L_I$ 为图片 $I$ 的标签集合，$w_I(c_k)$ 代表标签 $c_k$ 在图 $I$ 上的权重。
   $$
   \mathrm{Score}(I)=\sum_{c_k\in L_I} w_I(c_k)\times 100^{s_k}
   $$
   这里我们取了标签相似度 $s_k$ 的指数来增加标签相似的区分度（主要是增加相似度在1附近时的敏感性）。

4. 对候选图片根据相关得分进行排序，候选列表经条件筛选后返回

### 相似推荐

当用户查看一张图片的详情时，图片下方会显示一系列该图片的相似图片。引擎获得一张图片的相似图片的方式是将图片的**每个标签作为查询词**分别搜索，最后再将结果汇总（相关得分相加）。直观上，与该图片有越多相关标签的图片会被认为是相似图片。

### 条件筛选

本项目支持根据**大小、颜色**对搜索结果进行筛选。

由于数据集中图片尺寸都比较大，不易区分，因此我们选择根据图片的**文件大小**进行筛选。文件大小大于350KB为大图片(Large)，文件大小在150KB到350KB之间为中图片(Medium)，文件大小小于150KB为小图片。

在筛选界面，用户可以指定任意一种颜色（RGB值）作为筛选标准。在预处理图片时，数据库中会保存每张图片的五种主要颜色及其占比（使用`colorgram`库）。如果图片的**五种主要颜色中有任意一种颜色**与筛选颜色的（HSV空间中的）差别小于0.25，且该颜色在图片中的占比大于10%，则认为筛选通过。

在计算**颜色相似度**时，会首先将两种颜色转换至HSV空间，再计算其欧式距离。注意H维度中0和1代表同一个值，需要特殊处理。

```python
dh = min(abs(h1 - h2), 1 - abs(h1 - h2)) / 0.5
ds = abs(s1 - s2)
dv = abs(v1 - v2)
distance = math.sqrt(dh * dh + ds * ds + dv * dv)
```

## 测试结果

### 图片搜索

选择查询词进行搜索，记录前10个结果，计算相应的评价指标。结果标签 1 代表相关，0 代表不相关。注意“耗时”指前端发出请求到返回的耗时，包括网络传输时间、后端检索时间

| 查询词                              | 结果标签   | AP   | P@10 | RR   | success@10 | 耗时（ms） | 总结果数 |
| ----------------------------------- | ---------- | ---- | ---- | ---- | ---------- | ---------- | -------- |
| car                                 | 1111111111 | 1.00 | 1.00 | 1.00 | 1          | 114        | 5072     |
| table                               | 1111010011 | 0.83 | 0.70 | 1.00 | 1          | 88         | 614      |
| dog                                 | 1111111111 | 1.00 | 1.00 | 1.00 | 1          | 74         | 1152     |
| face                                | 0001111000 | 0.31 | 0.40 | 0.25 | 1          | 83         | 3380     |
| paper                               | 1100000001 | 0.50 | 0.30 | 1.00 | 1          | 77         | 13       |
| milk                                | 1111111111 | 1.00 | 1.00 | 1.00 | 1          | 78         | 420      |
| 牛奶                                | 1111111111 | 1.00 | 1.00 | 1.00 | 1          | 1889       | 420      |
| 人脸雕塑                            | 0011111101 | 0.49 | 0.70 | 0.33 | 1          | 1714       | 3549     |
| man playing football                | 1111100111 | 0.89 | 0.80 | 1.00 | 1          | 181        | 4022     |
| girl sitting on a chair near a desk | 1100000000 | 0.49 | 0.20 | 1.00 | 1          | 286        | 5908     |
| house near tree                     | 1111111111 | 1.00 | 1.00 | 1.00 | 1          | 169        | 3981     |

总体表现如下：

| MAP  | P@10 | MRR  |
| ---- | ---- | ---- |
| 0.77 | 0.74 | 0.87 |

可见总体表现较好，较差的两个查询 "girl sitting on a chair near a desk" 和 "face" 会在后面详细分析

### 颜色筛选

尺寸筛选必然准确，设计尺寸时分布也较为平均，性能评价没有意义，因此跳过

| 查询词 | 颜色（RGB） | 结果标签   | AP   | P@10 | RR   | success@10 | 耗时（ms） | 总结果数 |
| ------ | ----------- | ---------- | ---- | ---- | ---- | ---------- | ---------- | -------- |
| car    | 255,0,0     | 1111111111 | 1.00 | 1.00 | 1.00 | 1          | 197.2      | 78       |
| car    | 255,255,0   | 1111111000 | 0.94 | 0.70 | 1.00 | 1          | 185        | 25       |
| candy  | 59，168，30 | 1111110000 | 0.89 | 0.60 | 1.00 | 1          | 112        | 16       |

总体表现如下：

| MAP  | P@10 | MRR  |
| ---- | ---- | ---- |
| 0.94 | 0.77 | 1.00 |

### 相似图片

| 查询词       | 图片id              | 结果标签   | AP   | P@10 | RR   | success@10 |
| ------------ | ------------------- | ---------- | ---- | ---- | ---- | ---------- |
| man football | id=72ee2f15b5bdf139 | 1111011101 | 0.89 | 0.80 | 1.00 | 1          |
| man football | id=be0eddd107c6497d | 1111110011 | 0.92 | 0.80 | 1.00 | 1          |

总体表现如下：

| MAP  | P@10 | MRR  |
| ---- | ---- | ---- |
| 0.91 | 0.80 | 1.00 |



## 样例分析

在本节均选取前8个（不翻页显示）结果进行分析

### 图片搜索

milk：

<img src="图片搜索引擎实验报告_pic/image-20210608230446424.png" alt="image-20210608230446424" style="zoom:50%;" />

在这种简单的单词上，搜索结果除了 label 标注不合理外不会出现问题。

牛奶：

<img src="图片搜索引擎实验报告_pic/image-20210608230825759.png" alt="image-20210608230825759" style="zoom:50%;" />

同样，中文的简单词语可以完美翻译，结果也不会有问题

face：

<img src="图片搜索引擎实验报告_pic/image-20210609183154724.png" alt="image-20210609183154724" style="zoom:50%;" />

查询结果并不是非常准确，尤其是前两个图片可以说几乎完全无关。为了研究这一问题，我们查询了相关数据

相关 label 得分如下：

```
[('human face', 1.0), ('face powder', 1.0), ('human nose', 0.5381)]
```

查询结果得分与 label 如下：

```
20001.18363760337 ['face powder']
20000.88772820253 ['human face']
20000.591818801688 ['human face']
20000.0 ['human face']
15907.344729099785 ['human face', 'human mouth']
15906.871274058436 ['skull', 'human face']
15906.161091496411 ['human face', 'accordion']
15906.161091496411 ['person', 'human face']
15906.161091496411 ['sparrow', 'human face']
15906.161091496411 ['building', 'human face']
```

可见第一个结果的偏差主要是因为本项目算法将 "face" 与 "face powder" 算作了完全匹配，在这一点上我们的算法还有改进空间，可以尝试加入词组/句子的向量表示来代替现在的基础方法。其他结果的偏差主要来自于 label 标注错误，如第二张图的 positive label 只有一个 "human face" 导致其排名过于靠前，这显然是数据集的错误

girl sitting on a chair near a desk：

<img src="图片搜索引擎实验报告_pic/image-20210608224753739.png" alt="image-20210608224753739" style="zoom:50%;" />

这一查询的关键内容为 girl, chair, desk，前两个结果与我们的查询目标非常匹配，之后的结果都相对不相关，但是这是由于数据集的限制，与该查询匹配的只有这两张图片，因此搜索引擎在本查询下表现也是很优秀的

girl, chair, desk 都是 label，cos 相似度为 1.0，比例为 10000，on 和 a 被忽略，sitting 和 near 的相关 label 如下：

```
sitting: [('bull', 0.4546), ('seat belt', 0.4537), ('woman', 0.444)]
near: [('serving tray', 0.4517), ('common sunflower', 0.4303), ('common fig', 0.4303)]
```

可见其最高的 cos 相似度也低于 0.5，比例小于 100，我们的词向量相似度算法是非常有效的

### 颜色筛选

根据前面的实验，颜色在 "car" 这一关键词上表现最好，主要原因是 "car" 这一 label 对应图片较多，研究 "car" 在各种颜色下的结果

无颜色：

<img src="图片搜索引擎实验报告_pic/image-20210608223001031.png" alt="image-20210608223001031" style="zoom:50%;" />

红色：

<img src="图片搜索引擎实验报告_pic/image-20210608223101027.png" alt="image-20210608223101027" style="zoom:50%;" />

黄色：

<img src="图片搜索引擎实验报告_pic/image-20210608223108600.png" alt="image-20210608223108600" style="zoom:50%;" />

绿色：

<img src="图片搜索引擎实验报告_pic/image-20210608223129576.png" alt="image-20210608223129576" style="zoom:50%;" />

蓝色：

<img src="图片搜索引擎实验报告_pic/image-20210608223118903.png" alt="image-20210608223118903" style="zoom:50%;" />

黑色：

<img src="图片搜索引擎实验报告_pic/image-20210608223228268.png" alt="image-20210608223228268" style="zoom:50%;" />

可见在红、黄、绿、蓝等较为鲜艳，且在环境中出现较少的颜色表现较好，在这些颜色中错误结果主要来自相似色（黄6、蓝2）和相似色（黄4）。而在搜索黑色时因为其在环境中过于常见，结果并不好，如第6张图，显然是白车，但是此图中第二主要的颜色就是黑色，因此也会通过筛选器

### 相似图片

研究 "man football" 查询词下的两张图片

72ee2f15b5bdf139：

<img src="图片搜索引擎实验报告_pic/image-20210609184733142.png" alt="image-20210609184733142" style="zoom:50%;" />

be0eddd107c6497d：

<img src="图片搜索引擎实验报告_pic/image-20210609184748013.png" alt="image-20210609184748013" style="zoom:50%;" />

由于数据集 label 的限制，本搜索引擎无法区分足球和橄榄球（都是 "football"），这会对用户使用造成一定的不变，但是相似图片显然区分开了这两项运动。查询数据可知，橄榄球图片中大都有 "football helmet" 这一标签，而在足球图片中没有这一标签。这一点对用户来说都是极难想到的，如果没有相似图片这一功能，用户可能很难检索足球和橄榄球。同样，对于开发者来说，这种数据集上的局限性是很难处理的。相似图片功能可以在很大程度上解决这一问题，是很有意义的



## 开源资料

[Django](https://docs.djangoproject.com/en/3.2/)

[Vue.js](https://vuejs.org/v2/guide/)

[Nuxt.js](https://nuxtjs.org/docs/2.x/get-started/installation)

[Vuetify](https://vuetifyjs.com/en/getting-started/installation/)



## 参考代码

[Django](https://github.com/django/django)

[Vue.js](https://github.com/vuejs/vue)

[Nuxt.js](https://github.com/nuxt/nuxt.js)

[Vuetify](https://github.com/vuetifyjs/vuetify)

[vue-loading-overlay](https://github.com/ankurk91/vue-loading-overlay)



## 小组分工

乐阳：后端、数据预处理、算法

谢云桐：前端、算法

